<div id="uploadModal" style="display: none;">
    <div class="modal-overlay">
        <div class="modal-content">
            <h3>Upload File for <span id="serviceName"></span></h3>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <p>Drag and drop your file here</p>
                <p class="file-types" id="supportedFormats"></p>
                <input type="file" id="fileInput" style="display: none;">
                <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">
                    Browse Files
                </button>
            </div>
            
            <div id="fileInfo" style="display: none;">
                <h4>Selected File:</h4>
                <div id="fileDetails"></div>
            </div>
            
            <textarea id="instructions" placeholder="Special instructions (optional)"></textarea>
            
            <div class="modal-actions">
                <button class="btn-primary" onclick="submitUpload()">Upload File</button>
                <button class="btn-secondary" onclick="closeUploadModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
}

.upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    margin: 20px 0;
    transition: all 0.3s;
    background: #f9fafb;
}

.upload-area.dragover {
    border-color: #4f46e5;
    background: #e0e7ff;
}

.upload-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.file-types {
    font-size: 14px;
    color: #6b7280;
    margin: 10px 0;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}

.btn-primary {
    background: #4f46e5;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    flex: 1;
}

.btn-secondary {
    background: #6b7280;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
</style>

<script>
let currentService = null;
let selectedFile = null;

function openUploadModal(serviceType, serviceName, supportedFormats) {
    currentService = serviceType;
    document.getElementById('serviceName').textContent = serviceName;
    document.getElementById('supportedFormats').textContent = `Supported: ${supportedFormats.join(', ')}`;
    document.getElementById('uploadModal').style.display = 'block';
    resetUploadForm();
}

function closeUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
    resetUploadForm();
}

function resetUploadForm() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('instructions').value = '';
    document.getElementById('uploadArea').classList.remove('dragover');
}

// Drag and drop handlers
document.getElementById('uploadArea').addEventListener('dragover', (e) => {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
});

document.getElementById('uploadArea').addEventListener('dragleave', (e) => {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
});

document.getElementById('uploadArea').addEventListener('drop', (e) => {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

document.getElementById('fileInput').addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    selectedFile = file;
    
    const fileInfo = document.getElementById('fileInfo');
    const fileDetails = document.getElementById('fileDetails');
    
    fileDetails.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f3f4f6; border-radius: 6px;">
            <div>
                <strong>${file.name}</strong>
                <div style="font-size: 12px; color: #6b7280;">
                    ${(file.size / 1024 / 1024).toFixed(2)} MB
                </div>
            </div>
            <button onclick="resetUploadForm()" style="background: none; border: none; color: #ef4444; cursor: pointer;">√ó</button>
        </div>
    `;
    
    fileInfo.style.display = 'block';
}

async function submitUpload() {
    if (!selectedFile) {
        alert('Please select a file to upload.');
        return;
    }

    const instructions = document.getElementById('instructions').value;
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('service_type', currentService);
    formData.append('instructions', instructions);

    try {
        const response = await fetch('/api/files/upload', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            alert(`File uploaded successfully! Order ID: ${result.order_id}`);
            closeUploadModal();
            loadUserOrders(); // Refresh orders list
        } else {
            const error = await response.json();
            alert(`Upload failed: ${error.detail}`);
        }
    } catch (error) {
        alert('Upload failed. Please try again.');
    }
}

// Close modal when clicking outside
document.getElementById('uploadModal').addEventListener('click', (e) => {
    if (e.target.id === 'uploadModal') {
        closeUploadModal();
    }
});
</script>
